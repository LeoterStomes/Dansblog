---
import BaseHead from '../../components/BaseHead.astro';
import Footer from '../../components/Footer.astro';
import Header from '../../components/Header.astro';
import MobileDrawer from '../../components/MobileDrawer.astro';
import { SITE_TITLE } from '../../consts';
import { links } from '../../data/links';

const MAX_TAGS = 3;
const FRIENDS_PAGE_SIZE = 9;
const base = import.meta.env.BASE_URL || '/';
const withBase = (p: string) => `${base.replace(/\/$/, '')}/${String(p).replace(/^\//, '')}`;

const friendLinks = links
	.filter((item) => item.kind !== 'project')
	.sort((a, b) => {
		const order = { github: 0, bilibili: 1, project: 2 } as const;
		return order[a.kind] - order[b.kind];
	});
const friendPageCount = Math.max(1, Math.ceil(friendLinks.length / FRIENDS_PAGE_SIZE));
const friendPages = Array.from({ length: friendPageCount }, (_, index) =>
	friendLinks.slice(index * FRIENDS_PAGE_SIZE, (index + 1) * FRIENDS_PAGE_SIZE)
);
type FriendCard = (typeof friendLinks)[number];
type FriendPageItem = FriendCard | { __placeholder: true; id: string };
const friendPagesFilled: FriendPageItem[][] = friendPages.map((items, pageIndex) => {
	const missing = Math.max(0, FRIENDS_PAGE_SIZE - items.length);
	const placeholders: FriendPageItem[] = Array.from({ length: missing }, (_, itemIndex) => ({
		__placeholder: true,
		id: `friend-placeholder-${pageIndex}-${itemIndex}`,
	}));
	return [...items, ...placeholders];
});
const projectLinks = links.filter((item) => item.kind === 'project');
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={`Links | ${SITE_TITLE}`} description="Friends & Projects" />
	</head>
	<body>
		<Header />
		<MobileDrawer />
		<main class="mx-auto max-w-6xl px-4 py-12" transition:name="page-main" transition:animate="fade">
			<header>
				<h1 class="text-3xl font-semibold tracking-tight text-zinc-900 dark:text-zinc-100 md:text-4xl" transition:name="page-title" transition:animate="fade">
					Links
				</h1>
				<p class="mt-2 text-sm text-zinc-500 dark:text-zinc-400">Friends & Projects</p>
			</header>

			<section class="mt-8">
				<div class="flex items-center justify-between gap-4">
					<h2 class="text-sm font-semibold uppercase tracking-wide text-zinc-500 dark:text-zinc-400">Friends</h2>
					<div class="flex items-center gap-2">
						<button
							type="button"
							class="rounded-full border border-zinc-200 bg-white/90 px-3 py-1.5 text-sm text-zinc-700 shadow-sm backdrop-blur transition hover:bg-white dark:border-zinc-800 dark:bg-zinc-950/80 dark:text-zinc-200 dark:hover:bg-zinc-950 opacity-50 pointer-events-none invisible"
							data-friends-prev
							aria-label="Previous friends page"
						>
							Prev
						</button>
						<span class="text-sm text-zinc-500 dark:text-zinc-400" data-friends-pagination-status>1 / {friendPageCount}</span>
						<button
							type="button"
							class="rounded-full border border-zinc-200 bg-white/90 px-3 py-1.5 text-sm text-zinc-700 shadow-sm backdrop-blur transition hover:bg-white dark:border-zinc-800 dark:bg-zinc-950/80 dark:text-zinc-200 dark:hover:bg-zinc-950"
							data-friends-next
							aria-label="Next friends page"
						>
							Next
						</button>
					</div>
				</div>
				<div class="mt-4">
					<div
						class="grid grid-cols-1 gap-6 opacity-100 transition-opacity duration-300 ease-in-out sm:grid-cols-2 lg:grid-cols-3"
						data-friends-grid
					>
					</div>
					<div class="hidden" data-friends-pages-store>
						{
							friendPagesFilled.map((pageItems, pageIndex) => (
								<div data-friends-store-page={pageIndex}>
									{
										pageItems.map((item) => {
											if ('__placeholder' in item) {
												return (
													<article
														class="min-h-[210px] rounded-2xl border border-zinc-200 bg-white/90 p-5 opacity-0 pointer-events-none shadow-sm dark:border-zinc-800 dark:bg-zinc-950/80"
														aria-hidden="true"
													/>
												);
											}

											const tags = item.tags ?? [];
											const shown = tags.slice(0, MAX_TAGS);
											const more = Math.max(tags.length - shown.length, 0);
											const firstLetter = item.name.trim().charAt(0).toUpperCase() || 'L';
											const githubAvatar = item.github ? `https://github.com/${item.github}.png?size=160` : null;
											const avatarSrc = item.avatar ? withBase(item.avatar) : githubAvatar;

											return (
												<article class="min-h-[210px] rounded-2xl border border-zinc-200 bg-white/90 p-5 shadow-sm transition hover:shadow-md dark:border-zinc-800 dark:bg-zinc-950/80">
													<div class="flex items-start justify-between gap-3">
														<div class="flex items-center gap-3">
															{avatarSrc ? (
																<img
																	src={avatarSrc}
																	alt={`${item.name} avatar`}
																	class="h-11 w-11 rounded-full border border-zinc-200 object-cover dark:border-zinc-700"
																	loading="lazy"
																/>
															) : (
																<span class="inline-flex h-11 w-11 items-center justify-center rounded-full border border-zinc-200 bg-zinc-100 text-sm font-semibold text-zinc-700 dark:border-zinc-700 dark:bg-zinc-900 dark:text-zinc-200">
																	{firstLetter}
																</span>
															)}
															<div>
																<h3 class="text-base font-semibold text-zinc-900 dark:text-zinc-100">{item.name}</h3>
															</div>
														</div>
														<div class="flex items-center gap-2">
															{item.bilibili && (
																<a
																	href={item.bilibili}
																	target="_blank"
																	rel="noreferrer"
																	class="icon-button inline-flex h-8 w-8 items-center justify-center rounded-xl border border-zinc-200 text-zinc-600 transition-colors hover:border-zinc-400 hover:text-zinc-900 dark:border-zinc-700 dark:text-zinc-300 dark:hover:border-zinc-500 dark:hover:text-zinc-100"
																	aria-label={`${item.name} Bilibili`}
																>
																	<svg viewBox="0 0 24 24" class="h-4 w-4 fill-current" aria-hidden="true">
																		<path d="M7.4 2.8a1 1 0 0 1 1.4 0L12 6l3.2-3.2a1 1 0 1 1 1.4 1.4L14.5 6.3h3.8A3.7 3.7 0 0 1 22 10v8.3A3.7 3.7 0 0 1 18.3 22H5.7A3.7 3.7 0 0 1 2 18.3V10a3.7 3.7 0 0 1 3.7-3.7h3.8L7.4 4.2a1 1 0 0 1 0-1.4ZM5.7 8.3A1.7 1.7 0 0 0 4 10v8.3c0 .9.8 1.7 1.7 1.7h12.6c.9 0 1.7-.8 1.7-1.7V10c0-.9-.8-1.7-1.7-1.7H5.7Zm1.8 3a1 1 0 0 1 1 1v3.4a1 1 0 1 1-2 0v-3.4a1 1 0 0 1 1-1Zm9 0a1 1 0 0 1 1 1v3.4a1 1 0 1 1-2 0v-3.4a1 1 0 0 1 1-1Z" />
																	</svg>
																	<span class="sr-only">Bilibili</span>
																</a>
															)}
															{item.url && (
																<a
																	href={item.url}
																	target="_blank"
																	rel="noreferrer"
																	class="inline-flex items-center rounded-lg border border-zinc-200 px-2.5 py-1.5 text-xs font-medium text-zinc-700 no-underline transition hover:border-zinc-300 hover:bg-zinc-100 dark:border-zinc-700 dark:text-zinc-200 dark:hover:border-zinc-600 dark:hover:bg-zinc-800"
																>
																	Visit
																</a>
															)}
														</div>
													</div>

													{item.description && (
														<p class="friends-desc-clamp mt-4 text-sm leading-6 text-zinc-600 dark:text-zinc-300">{item.description}</p>
													)}

													{tags.length > 0 && (
														<div class="mt-4 flex flex-wrap gap-1.5">
															{shown.map((tag) => (
																<span class="inline-flex items-center rounded-full bg-zinc-100 px-2 py-0.5 text-xs text-zinc-600 dark:bg-zinc-800 dark:text-zinc-300">
																	{tag}
																</span>
															))}
															{more > 0 && (
																<span class="inline-flex items-center rounded-full bg-zinc-100 px-2 py-0.5 text-xs text-zinc-600 dark:bg-zinc-800 dark:text-zinc-300">
																	+{more}
																</span>
															)}
														</div>
													)}
												</article>
											);
										})
									}
								</div>
							))
						}
					</div>
				</div>
			</section>

			<section class="mt-12">
				<div class="mb-4">
					<h2 class="text-xl font-semibold tracking-tight text-zinc-900 dark:text-zinc-100">Projects</h2>
					<p class="mt-1 text-sm text-zinc-500 dark:text-zinc-400">Selected tools and product experiments.</p>
				</div>
				<div class="mt-4 grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3">
					{
						projectLinks.map((item) => {
							const tags = item.tags ?? [];
							const visibleTags = tags.slice(0, MAX_TAGS);
							const firstLetter = item.name.trim().charAt(0).toUpperCase() || 'P';
							const githubAvatar = item.github ? `https://github.com/${item.github}.png?size=160` : null;
							const avatarSrc = item.avatar ? withBase(item.avatar) : githubAvatar;

							return (
								<article class="rounded-2xl border border-zinc-200 bg-white/95 p-6 shadow-sm transition hover:shadow-md dark:border-zinc-800 dark:bg-zinc-950/85">
									<div class="flex items-start justify-between gap-3">
										<div class="flex items-center gap-3">
											{avatarSrc ? (
												<img
													src={avatarSrc}
													alt={`${item.name} avatar`}
													class="h-11 w-11 rounded-full border border-zinc-200 object-cover dark:border-zinc-700"
													loading="lazy"
												/>
											) : (
												<span class="inline-flex h-11 w-11 items-center justify-center rounded-full border border-zinc-200 bg-zinc-100 text-sm font-semibold text-zinc-700 dark:border-zinc-700 dark:bg-zinc-900 dark:text-zinc-200">
													{firstLetter}
												</span>
											)}
											<h3 class="text-lg font-semibold text-zinc-900 dark:text-zinc-100">{item.name}</h3>
										</div>
										{item.url && (
											<a
												href={item.url}
												target="_blank"
												rel="noreferrer"
												class="inline-flex items-center rounded-full border border-zinc-200 px-3 py-1.5 text-sm font-medium text-zinc-700 no-underline transition hover:border-zinc-300 hover:bg-zinc-100 dark:border-zinc-700 dark:text-zinc-200 dark:hover:border-zinc-600 dark:hover:bg-zinc-800"
											>
												Visit
											</a>
										)}
									</div>

									{item.description && (
										<p class="mt-4 text-sm leading-6 text-zinc-600 dark:text-zinc-300">{item.description}</p>
									)}

									{tags.length > 0 && (
										<div class="mt-4 flex flex-wrap gap-2">
											{visibleTags.map((tag) => (
												<span class="inline-flex items-center rounded-md bg-zinc-100 px-2 py-1 text-xs text-zinc-600 dark:bg-zinc-900 dark:text-zinc-300">
													{tag}
												</span>
											))}
										</div>
									)}
								</article>
							);
						})
					}
				</div>
			</section>
		</main>
		<Footer />
		<script is:inline>
			(() => {
				const prevButton = document.querySelector('[data-friends-prev]');
				const nextButton = document.querySelector('[data-friends-next]');
				const status = document.querySelector('[data-friends-pagination-status]');
				const grid = document.querySelector('[data-friends-grid]');
				const storePages = Array.from(document.querySelectorAll('[data-friends-store-page]'));
				if (!prevButton || !nextButton || !status || !grid || !storePages.length) return;

				let currentPage = 0;
				let isTransitioning = false;
				const lastPage = storePages.length - 1;
				const animationDuration = 280;

				const pageMarkup = (pageIndex) => {
					const source = storePages[pageIndex];
					return source ? source.innerHTML : '';
				};

				const syncButtons = () => {
					const hasMultiplePages = storePages.length > 1;
					const prevDisabled = isTransitioning || currentPage === 0 || !hasMultiplePages;
					const nextDisabled = isTransitioning || currentPage === lastPage || !hasMultiplePages;

					prevButton.classList.toggle('pointer-events-none', prevDisabled);
					prevButton.classList.toggle('opacity-50', prevDisabled);
					prevButton.classList.toggle('invisible', currentPage === 0);
					nextButton.classList.toggle('pointer-events-none', nextDisabled);
					nextButton.classList.toggle('opacity-50', nextDisabled);
					status.textContent = `${currentPage + 1} / ${storePages.length}`;
				};

				const switchPage = (targetPage) => {
					if (isTransitioning) return;
					if (targetPage < 0 || targetPage > lastPage || targetPage === currentPage) return;

					isTransitioning = true;
					syncButtons();

					grid.classList.remove('opacity-100');
					grid.classList.add('opacity-0');

					window.setTimeout(() => {
						grid.innerHTML = pageMarkup(targetPage);
						currentPage = targetPage;
						syncButtons();

						requestAnimationFrame(() => {
							grid.classList.remove('opacity-0');
							grid.classList.add('opacity-100');
						});

						window.setTimeout(() => {
							isTransitioning = false;
							syncButtons();
						}, animationDuration);
					}, animationDuration);
				};

				prevButton.addEventListener('click', () => {
					switchPage(currentPage - 1);
				});

				nextButton.addEventListener('click', () => {
					switchPage(currentPage + 1);
				});

				grid.innerHTML = pageMarkup(0);
				grid.classList.remove('opacity-0');
				grid.classList.add('opacity-100');
				syncButtons();
			})();
		</script>
		<style>
			.friends-desc-clamp {
				display: -webkit-box;
				-webkit-line-clamp: 3;
				-webkit-box-orient: vertical;
				overflow: hidden;
			}
		</style>
	</body>
</html>
